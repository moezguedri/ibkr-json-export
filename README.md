# ðŸ“¦ IBKR Portfolio Snapshot â†’ One JSON (Portfolio + Symbols)

A robust Python tool that connects to Interactive Brokers (IBKR) via `ib_insync`,
optionally enriches with Yahoo Finance (`yfinance`), and exports a **single**
decision-ready JSON snapshot:

- `portfolio`: positions, derived weights, largest holding, account values
- `symbols`: market data + derived metrics per symbol (drawdown, MA200, etc.)

This JSON is designed to be **self-contained**, audit-friendly, and easy to consume
from a CLI today (console output) and a web UI later.

---

## âœ… What this project produces

### 1) Snapshot JSON (single file)
A single file like:

- `snapshots/portfolio_snapshot_YYYYMMDD_HHMM.json`

It contains two top-level sections:

- `portfolio`
- `symbols`

### 2) (Next step) Monthly decision plan JSON
A second JSON (generated by the decision engine) like:

- `decisions/decision_plan_YYYYMMDD_HHMM.json`

This will contain:

- DCA Basic plan (fixed monthly budget, target weights, locks)
- Opportunistic plan (drawdown-based sizing + MA200 pacing, caps, locks)
- Diagnostics per symbol for transparency

---

## ðŸ§© Snapshot schema (high level)

### `portfolio`
Includes (at minimum):

- current holdings and values
- **derived**:
  - current weights per tracked symbol (`tracked_weights_pct`)
  - largest holding symbol (`largest_holding_stock_symbol`)

These fields are used by locks like:
- max position weight (e.g., 20%)
- NVDA forbidden if it is the largest holding

### `symbols`
For each tracked symbol:

- daily price history (optional, kept for future refinements)
- intraday history (optional)
- fundamentals (optional)
- open orders (optional)
- **core_metrics** (required for decision engine):
  - `last_close`
  - `high_12m` (close-based, last 252 trading days)
  - `drawdown_12m_close_pct`
  - `ma200` (200-day SMA of close)
  - `below_ma200` (bool)

---

## ðŸŽ¯ Why one JSON snapshot?

Because it makes the system:

- **Reproducible**: decisions can be replayed from an immutable snapshot
- **Debuggable**: inspect the snapshot if a decision looks wrong
- **Offline-friendly**: analysis/decisions do not require live IBKR access
- **Web-friendly**: a single JSON is easier to render in a UI

---

## ðŸ›  Prerequisites

- Python 3.10+
- IBKR TWS or IB Gateway running locally (or reachable)
- IBKR API enabled

Install dependencies:

```bash
pip install ib_insync yfinance pandas tzdata
